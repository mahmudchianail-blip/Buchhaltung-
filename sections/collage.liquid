{{ 'collage.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-modal-video.css' | asset_url | stylesheet_tag }}
{{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: clamp(12px, {{ section.settings.padding_top }}px * 0.6, {{ section.settings.padding_top }}px);
    padding-bottom: clamp(12px, {{ section.settings.padding_bottom }}px * 0.6, {{ section.settings.padding_bottom }}px);
  }

  .collage--modern {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--grid-gap, 16px);
    content-visibility: auto;
    contain: content;
  }
  @media (min-width: 750px) {
    .collage--modern {
      grid-template-columns: {% if section.settings.desktop_layout == 'left' or section.settings.desktop_layout == 'right' %}2fr 1fr 1fr{% else %}repeat(3, 1fr){% endif %};
      gap: var(--grid-gap-desktop, 20px);
    }
  }

  {% if section.settings.enable_mobile_snap %}
  .collage--mobile-snap {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 80%;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    gap: 16px;
  }
  .collage--mobile-snap > * { scroll-snap-align: start; }
  {% endif %}

  .collage__item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
  }

  .collage-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 10px;
  }
  .collage-view-all {
    font: inherit;
    text-decoration: none;
    border: 1px solid currentColor;
    padding: 6px 12px;
    border-radius: 999px;
    white-space: nowrap;
  }

  .collage-overlay {
    position: absolute;
    inset: auto 0 0 0;
    padding: 16px;
    display: grid;
    gap: 6px;
  }
  .collage-overlay--top-left    { inset: 0 auto auto 0; padding: 16px; }
  .collage-overlay--top-right   { inset: 0 0 auto auto; padding: 16px; text-align: right; }
  .collage-overlay--bottom-left { inset: auto auto 0 0; padding: 16px; }
  .collage-overlay--bottom-right{ inset: auto 0 0 auto; padding: 16px; text-align: right; }

  .overlay--light { color: #111; }
  .overlay--light .chip { background: rgba(255,255,255,.8); color:#111; }
  .overlay--dark  { color: #fff; }
  .overlay--dark .chip { background: rgba(0,0,0,.5); color:#fff; }

  .collage-overlay .title { font-weight: 700; font-size: clamp(16px, 1.4vw, 20px); }
  .collage-overlay .subtitle { font-size: 14px; opacity:.9; }
  .collage-overlay .chip {
    display: inline-block;
    padding: 6px 10px;
    border-radius: 999px;
    text-decoration: none;
    margin-top: 6px;
  }

  {% if section.settings.enable_hover_effects %}
  .collage__item .media img { transition: transform .35s ease, filter .35s ease; }
  .collage__item:hover .media img { transform: scale(1.03); }
  .collage__item:hover { box-shadow: 0 10px 30px rgba(0,0,0,.08); }
  {% endif %}

  @media (prefers-reduced-motion: reduce) {
    .animate--slide-in { animation: none !important; }
    .collage__item .media img { transition: none !important; }
  }
{%- endstyle -%}

{%- liquid
  assign spacing_horizontal = settings.spacing_grid_horizontal | default: 24
  assign grid_space_desktop = spacing_horizontal | divided_by: 2 | append: 'px'
  assign grid_space_mobile  = spacing_horizontal | divided_by: 4 | append: 'px'
-%}

<div class="color-{{ section.settings.color_scheme }} gradient isolate">
  <div class="page-width section-{{ section.id }}-padding">

    {% if section.settings.heading != blank or section.settings.show_view_all %}
    <div class="collage-header">
      {%- if section.settings.heading != blank -%}
        <h2 class="collage-wrapper-title inline-richtext {{ section.settings.heading_size }}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
            {% if settings.animations_reveal_on_scroll %}style="--animation-order: 0;"{% endif %}>
          {{ section.settings.heading }}
        </h2>
      {%- endif -%}
      {%- if section.settings.show_view_all and section.settings.view_all_link != blank -%}
        <a class="collage-view-all" href="{{ section.settings.view_all_link }}" aria-label="{{ section.settings.view_all_text | default: 'Alle ansehen' }}">
          {{ section.settings.view_all_text | default: 'Alle ansehen' }}
        </a>
      {%- endif -%}
    </div>
    {% endif %}

    <div class="collage collage--modern{% if section.settings.mobile_layout == 'collage' %} collage--mobile{% endif %}{% if section.settings.enable_mobile_snap %} collage--mobile-snap{% endif %}"
         role="list">
      {% assign skip_card_product_styles = false %}
      {%- for block in section.blocks -%}
        <div
          class="collage__item collage__item--{{ block.type }} collage__item--{{ section.settings.desktop_layout }}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
          {{ block.shopify_attributes }}
          role="listitem"
          {% if settings.animations_reveal_on_scroll %}
            data-cascade
            style="--animation-order: {{ forloop.index }};"
          {% endif %}
        >
          {%- assign placeholder_image_index = forloop.index0 | modulo: 4 | plus: 1 -%}
          {%- case block.type -%}

            {%- when 'image' -%}
              <div class="collage-card {% if section.settings.card_styles == 'none' %}global-media-settings{% else %}card-wrapper {{ section.settings.card_styles }} color-{{ settings.card_color_scheme }} gradient{% endif %}">
                <div
                  class="media media--transparent ratio"
                  {% if block.settings.image != blank %}
                    style="--ratio-percent: {{ 1 | divided_by: block.settings.image.aspect_ratio | times: 100 }}%"
                  {% else %}
                    style="--ratio-percent: 100%"
                  {% endif %}
                >
                  {%- if block.settings.image != blank -%}
                    {%- liquid
                      if section.settings.desktop_layout == 'left'
                        assign large_block = forloop.first
                      else
                        assign large_block = forloop.last
                      endif
                    -%}
                    {%- if large_block -%}
                      {%- capture sizes -%}
                        {% if section.blocks.size == 1 -%}
                          (min-width: {{ settings.page_width }}px) calc({{ settings.page_width }}px - 100px)
                        {%- else -%}
                          (min-width: {{ settings.page_width }}px) calc(({{ settings.page_width }}px - 100px) * 2 / 3 - {{ grid_space_desktop }})
                        {%- endif -%},
                        {% if section.blocks.size == 1 -%}
                          (min-width: 750px) calc(100vw - 100px)
                        {%- else -%}
                          (min-width: 750px) calc((100vw - 100px) * 2 / 3 - {{ grid_space_desktop }})
                        {%- endif -%},
                        {% if section.blocks.size == 2 and section.settings.mobile_layout == 'collage' -%}
                          calc((100vw - 30px) / 2)
                        {%- else -%}
                          calc(100vw - 30px)
                        {%- endif -%}
                      {%- endcapture -%}
                    {%- else -%}
                      {%- capture sizes -%}
                        (min-width: {{ settings.page_width }}px) calc(({{ settings.page_width }}px - 100px) * 1 / 3 - {{ grid_space_desktop }}),
                        (min-width: 750px) calc((100vw - 100px) * 1 / 3 - {{ grid_space_desktop }}),
                        {% if section.settings.mobile_layout == 'collage' %}
                          calc((100vw - 30px) / 2 - {{ grid_space_mobile }})
                        {% else %}
                          calc(100vw - 30px)
                        {% endif %}
                      {%- endcapture -%}
                    {%- endif -%}

                    {%- assign alt_text = block.settings.image.alt | default: section.settings.heading -%}
                    {%- if forloop.first -%}{%- assign loading_attr = 'eager' -%}{%- else -%}{%- assign loading_attr = 'lazy' -%}{%- endif -%}
                    {%- assign widths_list = '320,480,640,750,900,1100,1300,1600,2000,2400,3200' | split: ',' -%}
                    {%- capture collage_srcset -%}
                      {%- for w in widths_list -%}
                        {{ block.settings.image | image_url: width: w }} {{ w }}w{% unless forloop.last %}, {% endunless %}
                      {%- endfor -%}
                    {%- endcapture -%}
                    <img
                      src="{{ block.settings.image | image_url: width: 1100 }}"
                      srcset="{{ collage_srcset | strip }}"
                      sizes="{{ sizes | strip }}"
                      alt="{{ alt_text | escape }}"
                      loading="{{ loading_attr }}"
                      width="{{ block.settings.image.width }}"
                      height="{{ block.settings.image.height }}"
                    >
                  {%- else -%}
                    {{ 'detailed-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  {%- endif -%}
                </div>

                {%- if block.settings.overlay_enable -%}
                  {%- assign overlay_pos = block.settings.overlay_position | default: 'bottom-left' -%}
                  <div class="collage-overlay collage-overlay--{{ overlay_pos }} overlay--{{ block.settings.overlay_style | default: 'dark' }}">
                    {%- if block.settings.overlay_title != blank -%}
                      <div class="title">{{ block.settings.overlay_title }}</div>
                    {%- endif -%}
                    {%- if block.settings.overlay_subtitle != blank -%}
                      <div class="subtitle">{{ block.settings.overlay_subtitle }}</div>
                    {%- endif -%}
                    {%- if block.settings.overlay_cta_label != blank and block.settings.overlay_cta_link != blank -%}
                      <a class="chip" href="{{ block.settings.overlay_cta_link }}">{{ block.settings.overlay_cta_label }}</a>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              </div>

            {%- when 'product' -%}
              {%- assign placeholder_image = 'product-apparel-' | append: placeholder_image_index -%}
              {% render 'card-product',
                card_product: block.settings.product,
                media_aspect_ratio: 'adapt',
                show_secondary_image: block.settings.second_image,
                extend_height: true,
                placeholder_image: placeholder_image,
                skip_styles: skip_card_product_styles
              %}
              {% assign skip_card_product_styles = true %}

            {%- when 'collection' -%}
              {%- assign placeholder_image = 'collection-apparel-' | append: placeholder_image_index -%}
              {% render 'card-collection',
                card_collection: block.settings.collection,
                media_aspect_ratio: 'adapt',
                columns: 2,
                extend_height: true,
                wrapper_class: section.settings.card_styles,
                placeholder_image: placeholder_image
              %}

            {%- when 'video' -%}
              <div class="collage-card {% if section.settings.card_styles == 'none' %}global-media-settings{% else %}{{ section.settings.card_styles }} color-{{ settings.card_color_scheme }} gradient{% endif %}">
                <modal-opener data-modal="#PopupModal-{{ block.id }}">
                  <div class="deferred-media">
                    <button
                      class="deferred-media__poster full-unstyled-link"
                      type="button"
                      aria-label="{{ 'sections.video.load_video' | t: description: block.settings.description | escape }}"
                      aria-haspopup="dialog"
                      data-media-id="{{ block.settings.video_url.id }}"
                    >
                      <div
                        class="media media--transparent ratio"
                        {% if block.settings.cover_image != blank %}
                          style="--ratio-percent: {{ 1 | divided_by: block.settings.cover_image.aspect_ratio | times: 100 }}%"
                        {% else %}
                          style="--ratio-percent: 100%"
                        {% endif %}
                      >
                        <span class="deferred-media__poster-button motion-reduce">
                          <span class="svg-wrapper">
                            {{- 'icon-play.svg' | inline_asset_content -}}
                          </span>
                        </span>

                        {%- if block.settings.cover_image != blank -%}
                          {%- capture sizes -%}
                            (min-width: {{ settings.page_width }}px)
                            {% if section.blocks.size == 1 -%}
                              calc({{ settings.page_width }}px - 100px)
                            {%- else -%}
                              {{- settings.page_width | minus: 100 | times: 0.67 | round }}px
                            {%- endif -%}
                            , (min-width: 750px)
                            {%- if section.blocks.size == 1 %} calc(100vw - 100px){% else %} 500px{% endif -%}
                            , calc(100vw - 30px)
                          {%- endcapture -%}
                          {%- assign alt_text = block.settings.description | default: section.settings.heading -%}
                          {%- assign widths_list = '550,720,990,1100,1500,2200,3000' | split: ',' -%}
                          {%- capture cover_srcset -%}
                            {%- for w in widths_list -%}
                              {{ block.settings.cover_image | image_url: width: w }} {{ w }}w{% unless forloop.last %}, {% endunless %}
                            {%- endfor -%}
                          {%- endcapture -%}
                          <img
                            src="{{ block.settings.cover_image | image_url: width: 990 }}"
                            srcset="{{ cover_srcset | strip }}"
                            sizes="{{ sizes | strip }}"
                            alt="{{ alt_text | escape }}"
                            loading="lazy"
                            width="{{ block.settings.cover_image.width }}"
                            height="{{ block.settings.cover_image.height }}"
                          >
                        {%- else -%}
                          {{ 'hero-apparel-3' | placeholder_svg_tag: 'placeholder-svg placeholder' }}
                        {%- endif -%}
                      </div>
                    </button>
                  </div>
                </modal-opener>

                <modal-dialog
                  id="PopupModal-{{ block.id }}"
                  class="modal-video media-modal color-{{ section.settings.color_scheme }}"
                >
                  <div
                    class="modal-video__content"
                    role="dialog"
                    aria-label="{{ block.settings.description | escape }}"
                    aria-modal="true"
                    tabindex="-1"
                  >
                    <button
                      id="ModalClose-{{ block.id }}"
                      type="button"
                      class="modal-video__toggle"
                      aria-label="{{ 'accessibility.close' | t }}"
                    >
                      <span class="svg-wrapper">
                        {{- 'icon-close.svg' | inline_asset_content -}}
                      </span>
                    </button>
                    <div class="modal-video__content-info">
                      <deferred-media class="modal-video__video template-popup">
                        <template>
                          {%- if block.settings.video_url.type == 'youtube' -%}
                            <iframe
                              src="https://www.youtube.com/embed/{{ block.settings.video_url.id }}?enablejsapi=1"
                              class="js-youtube"
                              allow="autoplay; encrypted-media"
                              allowfullscreen
                              title="{{ block.settings.description | escape }}"
                              loading="lazy"
                            ></iframe>
                          {%- else -%}
                            <iframe
                              src="https://player.vimeo.com/video/{{ block.settings.video_url.id }}"
                              class="js-vimeo"
                              allow="autoplay; encrypted-media"
                              allowfullscreen
                              title="{{ block.settings.description | escape }}"
                              loading="lazy"
                            ></iframe>
                          {%- endif -%}
                        </template>
                      </deferred-media>
                    </div>
                  </div>
                </modal-dialog>
              </div>

          {%- endcase -%}
        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Collage (Modern)",
  "tag": "section",
  "class": "section",
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    { "type": "inline_richtext", "id": "heading", "default": "Entdecke unsere Favoriten", "label": "Überschrift" },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "H2" },
        { "value": "h1", "label": "H1" },
        { "value": "h0", "label": "Hero" },
        { "value": "hxl", "label": "XL" },
        { "value": "hxxl", "label": "XXL" }
      ],
      "default": "h1",
      "label": "Überschrift Größe"
    },
    { "type": "header", "content": "Layout" },
    {
      "type": "select",
      "id": "desktop_layout",
      "options": [
        { "value": "left", "label": "Großes Element links" },
        { "value": "right", "label": "Großes Element rechts" }
      ],
      "default": "left",
      "label": "Desktop-Layout"
    },
    {
      "type": "select",
      "id": "mobile_layout",
      "options": [
        { "value": "collage", "label": "Collage" },
        { "value": "column", "label": "Spalten" }
      ],
      "default": "column",
      "label": "Mobile-Layout"
    },
    {
      "type": "checkbox",
      "id": "enable_mobile_snap",
      "default": true,
      "label": "Mobile horizontales Scrollen (Snap) aktivieren"
    },
    {
      "type": "select",
      "id": "card_styles",
      "options": [
        { "value": "none", "label": "Keine Karten" },
        { "value": "product-card-wrapper", "label": "Kartenstil (Dawn)" }
      ],
      "default": "product-card-wrapper",
      "label": "Kartenstil"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Farbschema",
      "default": "scheme-1"
    },
    { "type": "header", "content": "Aktionen" },
    { "type": "checkbox", "id": "show_view_all", "default": false, "label": "„Alle ansehen“-CTA anzeigen" },
    { "type": "text", "id": "view_all_text", "default": "Alle ansehen", "label": "CTA-Text" },
    { "type": "url", "id": "view_all_link", "label": "CTA-Link" },
    { "type": "checkbox", "id": "enable_hover_effects", "default": true, "label": "Hover-Effekt aktivieren" },
    { "type": "header", "content": "Abstände" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Abstand oben", "default": 36 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Abstand unten", "default": 36 }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Bild",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Bild" },
        { "type": "checkbox", "id": "overlay_enable", "default": false, "label": "Overlay anzeigen" },
        { "type": "text", "id": "overlay_title", "label": "Overlay Titel" },
        { "type": "text", "id": "overlay_subtitle", "label": "Overlay Untertitel" },
        { "type": "text", "id": "overlay_cta_label", "label": "Overlay CTA-Text" },
        { "type": "url", "id": "overlay_cta_link", "label": "Overlay CTA-Link" },
        {
          "type": "select",
          "id": "overlay_style",
          "label": "Overlay Stil",
          "options": [
            { "value": "dark", "label": "Dunkel (weiß auf Bild)" },
            { "value": "light", "label": "Hell (schwarz auf Bild)" }
          ],
          "default": "dark"
        },
        {
          "type": "select",
          "id": "overlay_position",
          "label": "Overlay Position",
          "options": [
            { "value": "top-left", "label": "Oben links" },
            { "value": "top-right", "label": "Oben rechts" },
            { "value": "bottom-left", "label": "Unten links" },
            { "value": "bottom-right", "label": "Unten rechts" }
          ],
          "default": "bottom-left"
        }
      ]
    },
    {
      "type": "product",
      "name": "Produkt",
      "settings": [
        { "type": "product", "id": "product", "label": "Produkt" },
        { "type": "checkbox", "id": "second_image", "default": false, "label": "Sekundärbild zeigen" }
      ]
    },
    {
      "type": "collection",
      "name": "Kollektion",
      "settings": [
        { "type": "collection", "id": "collection", "label": "Kollektion" }
      ]
    },
    {
      "type": "video",
      "name": "Video",
      "settings": [
        { "type": "image_picker", "id": "cover_image", "label": "Cover-Bild" },
        {
          "type": "video_url",
          "id": "video_url",
          "accept": ["youtube", "vimeo"],
          "default": "https://www.youtube.com/watch?v=_9VUPq3SxOc",
          "label": "Video-URL"
        },
        { "type": "text", "id": "description", "default": "Produktvideo", "label": "Beschreibung" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    {
      "name": "Collage (Modern)",
      "blocks": [{ "type": "image" }, { "type": "product" }, { "type": "collection" }]
    }
  ]
}
{% endschema %}
